# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Twitter bookmark manager application similar to Tweetsmash, optimized for Vercel's free tier. It automatically captures Twitter bookmarks, uses Claude AI to analyze and categorize them, generates summaries of long threads, and exports everything to Google Sheets with smart organization.

## Tech Stack

- **Frontend**: Next.js 15 with TypeScript, Tailwind CSS, Lucide React icons
- **Backend**: Next.js API routes (serverless), NextAuth.js for authentication
- **Database**: Vercel Postgres (production), SQLite (development) with Prisma ORM
- **Queue System**: Upstash Redis for background job processing
- **AI**: Anthropic Claude API for bookmark analysis
- **External APIs**: Twitter API v2, Google Sheets API
- **Deployment**: Vercel with cron jobs for automation
- **UI Components**: Custom components built with Radix UI primitives

## Development Commands

```bash
# Install dependencies
npm install

# Start development server
npm run dev

# Build for production  
npm run build

# Start production server
npm start

# Lint code
npm run lint

# Type check
npm run type-check

# Database operations
npm run db:generate    # Generate Prisma client
npm run db:push        # Push schema to database
npm run db:migrate     # Create and apply migrations
npm run db:studio      # Open Prisma Studio
```

## Environment Variables

Copy `.env.example` to `.env.local` and configure these required variables:

### Development (Local)
```bash
# Local SQLite Database
DATABASE_URL="file:./dev.db"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generate-a-random-secret"

# Twitter API (from developer.twitter.com)
TWITTER_API_KEY="your-twitter-api-key"
TWITTER_API_SECRET="your-twitter-api-secret"
TWITTER_ACCESS_TOKEN="your-twitter-access-token"
TWITTER_ACCESS_SECRET="your-twitter-access-token-secret"

# Claude AI (from console.anthropic.com)
ANTHROPIC_API_KEY="sk-ant-api03-..."

# Google Sheets (service account)
GOOGLE_CLIENT_EMAIL="your-service-account@project.iam.gserviceaccount.com"
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"

# Upstash Redis (OPTIONAL - for production, local development uses file-based queue)
# UPSTASH_REDIS_REST_URL="https://..."
# UPSTASH_REDIS_REST_TOKEN="..."

# Cron job security (OPTIONAL - for Vercel cron jobs)
# CRON_SECRET="your-random-cron-secret"
```

**Note**: Redis and CRON_SECRET are optional for local development. The app will automatically use a local file-based queue system if Redis is not configured.

### Production (Vercel)
Set these in Vercel dashboard under Environment Variables:
- `POSTGRES_PRISMA_URL` and `POSTGRES_URL_NON_POOLING` (auto-generated by Vercel Postgres)
- `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN` (from Upstash Redis)
- `CRON_SECRET` (for securing cron job endpoints)
- All other variables from the development section

## Project Structure

```
src/
├── app/                    # Next.js app router
│   ├── api/               # Serverless API routes
│   │   ├── auth/          # NextAuth endpoints
│   │   ├── bookmarks/     # Bookmark management APIs
│   │   ├── cron/          # Vercel cron job endpoints
│   │   └── queue/         # Background queue APIs
│   ├── layout.tsx         # Root layout with providers
│   └── page.tsx           # Main dashboard page
├── components/            # React components
│   ├── ui/               # Base UI components (Button, Card, Input)
│   ├── BookmarkCard.tsx  # Individual bookmark display
│   ├── BookmarkList.tsx  # Main bookmark listing with filters
│   ├── QueueStatus.tsx   # Background job queue status
│   └── Providers.tsx     # Session provider wrapper
└── lib/                  # Utility libraries
    ├── auth.ts           # NextAuth configuration
    ├── claude.ts         # Claude AI integration
    ├── google-sheets.ts  # Google Sheets export
    ├── prisma.ts         # Prisma client setup (optimized for serverless)
    ├── queue.ts          # Background job queue system
    ├── redis.ts          # Upstash Redis integration
    ├── twitter.ts        # Twitter API integration
    └── utils.ts          # Utility functions

vercel.json                # Vercel deployment configuration
```

## Key Features Implementation

### 1. Vercel Cron Jobs (Automated)
- **Bookmark Sync** (`/api/cron/sync-bookmarks`): Runs every 6 hours to fetch new bookmarks
- **Queue Processing** (`/api/cron/process-queue`): Runs every 5 minutes to analyze queued bookmarks
- Protected by `CRON_SECRET` environment variable

### 2. Background Job Queue (`src/lib/queue.ts` + `src/lib/redis.ts` + `src/lib/local-queue.ts`)
- **Production**: Uses Upstash Redis for serverless-friendly job queue
- **Development**: Uses local file-based queue system (no external dependencies)
- Auto-detects environment and chooses appropriate queue implementation
- Bookmark sync creates raw bookmark records and queues them for analysis
- AI analysis runs in background to avoid serverless function timeouts
- Fallback to immediate processing if queue is unavailable

### 3. Serverless-Optimized Database
- **Development**: SQLite for local development
- **Production**: Vercel Postgres with connection pooling
- Prisma client optimized for serverless with proper logging

### 4. AI Analysis (`src/lib/claude.ts`)
- Uses Claude Haiku for cost-effective analysis
- Processes bookmarks from queue in batches
- Categorizes, summarizes, and extracts keywords
- Handles Twitter threads with full context

### 5. Real-time UI Updates
- Queue status component shows pending analysis jobs
- Automatic refresh every 10 seconds
- Visual indicators for analysis progress
- **Development**: Manual "Process Now" button for local queue processing
- **Production**: Automatic processing via cron jobs

## Database Schema

The Prisma schema includes:
- **User**: NextAuth user management
- **Account/Session**: OAuth token storage
- **Bookmark**: Core bookmark data with AI analysis fields
  - `category`, `summary`, `sentiment`, `keywords`
  - `isThread`, `threadSummary` for multi-tweet content
  - `exportedToSheets`, `exportedAt` for export tracking

## Quick Start (Local Development)

### Minimal Setup - No External Services Required
1. **Clone and install**:
   ```bash
   git clone <repo-url>
   cd twitter-bookmark-manager
   npm install
   ```

2. **Basic environment setup**:
   ```bash
   cp .env.example .env.local
   # Edit .env.local - only set NEXTAUTH_SECRET and DATABASE_URL
   ```

3. **Initialize database**:
   ```bash
   npm run db:generate
   npm run db:push
   ```

4. **Start development**:
   ```bash
   npm run dev
   ```

The app will run with:
- Local SQLite database
- File-based queue system (no Redis needed)
- Mock implementations for external APIs during development

## Full Production Deployment Guide

### 1. Prerequisites
- Vercel account with GitHub integration
- Upstash Redis database (free tier)
- Twitter Developer account with API keys
- Anthropic Claude API key
- Google Service Account for Sheets API

### 2. Deployment Steps
1. **Connect Repository**: Link GitHub repo to Vercel
2. **Add Postgres**: Install Vercel Postgres add-on (creates `POSTGRES_*` env vars)
3. **Set Environment Variables**: Add all required env vars in Vercel dashboard
4. **Deploy**: Vercel auto-deploys on push to main branch
5. **Run Migration**: `npx prisma migrate deploy` in Vercel CLI or manually

### 3. Vercel Configuration (`vercel.json`)
- Cron jobs run automatically (every 6 hours for sync, every 5 minutes for queue)
- Function timeout: 30s for regular APIs, 60s for cron jobs
- All API routes are serverless functions

## Development Notes

- **Serverless Architecture**: All functions are stateless and optimized for cold starts
- **Queue System**: Heavy processing (AI analysis) runs in background via Redis queue
- **Database**: Connection pooling handled by Vercel Postgres automatically
- **Cron Jobs**: Secured with CRON_SECRET and run on Vercel's infrastructure
- **Error Handling**: Proper logging and user-friendly error messages
- **Cost Optimization**: Uses Claude Haiku and efficient Redis operations

## Common Issues

- **Cold Starts**: First request may be slow; subsequent requests are fast
- **Function Timeouts**: Long operations moved to background queue
- **Database Connections**: Use Prisma's connection pooling for Vercel Postgres
- **Cron Security**: Ensure CRON_SECRET is set and matches in all environments
- **Redis Connection**: Upstash Redis REST API is serverless-friendly